<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Carte des chauffeurs</title>
  <style>
    html, body, #map {
      height: 100%;
      margin: 0;
      padding: 0;
    }

    /* Movable and closable legend styling */
    .legend {
      position: absolute;
      bottom: 10px;
      left: 10px;
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.3);
      font-family: Arial, sans-serif;
      font-size: 14px;
      width: 200px;
      cursor: move;
      z-index: 1000;
      border: 1px solid #ddd;
    }

    .legend-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      padding-bottom: 8px;
      border-bottom: 1px solid #eee;
      font-weight: bold;
      cursor: move;
    }

    .legend-title {
      font-size: 16px;
      color: #333;
    }

    .legend-close {
      cursor: pointer;
      font-size: 18px;
      color: #666;
      font-weight: bold;
      padding: 0 5px;
      border-radius: 3px;
      transition: background-color 0.2s;
    }

    .legend-close:hover {
      background-color: #f0f0f0;
      color: #333;
    }

    .legend-content {
      display: block;
    }

    .legend-content.hidden {
      display: none;
    }

    .legend-item {
      display: flex;
      align-items: center;
      margin-bottom: 8px;
    }

    .legend-item:last-child {
      margin-bottom: 0;
    }

    .legend-color {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      display: inline-block;
      margin-right: 10px;
      border: 2px solid #333;
    }

    .legend-text {
      flex: 1;
      font-size: 13px;
      color: #333;
    }

    /* Toggle button for showing legend when hidden */
    .legend-toggle {
      position: absolute;
      bottom: 10px;
      left: 10px;
      background: white;
      padding: 10px 15px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      font-family: Arial, sans-serif;
      font-size: 14px;
      cursor: pointer;
      z-index: 1000;
      border: 1px solid #ddd;
      display: none;
    }

    .legend-toggle:hover {
      background-color: #f9f9f9;
    }

    /* Dragging state */
    .legend.dragging {
      opacity: 0.8;
      transform: rotate(2deg);
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- Movable and closable legend -->
  <div class="legend" id="legend">
    <div class="legend-header" id="legend-header">
      <span class="legend-title">Driver Position</span>
      <span class="legend-close" id="legend-close">&times;</span>
    </div>
    <div class="legend-content" id="legend-content">
      <div class="legend-item">
        <span class="legend-color" style="background: green; border-color: green;"></span>
        <span class="legend-text">Driver GPS &lt; 24h</span>
      </div>
      <div class="legend-item">
        <span class="legend-color" style="background: blue; border-color: blue;"></span>
        <span class="legend-text">Driver GPS &lt; 48h</span>
      </div>
      <div class="legend-item">
        <span class="legend-color" style="background: red; border-color: red;"></span>
        <span class="legend-text">Driver GPS &gt; 48h</span>
      </div>
    </div>
  </div>

  <!-- Toggle button (shown when legend is closed) -->
  <div class="legend-toggle" id="legend-toggle">
    Legend
  </div>

 <script>
let map;
let markers = [];

// Dragging functionality
let isDragging = false;
let dragOffset = { x: 0, y: 0 };

function getJobIdFromURL() {
	  const params = new URLSearchParams(window.location.search);
	  return params.get("jobId");
	}
function getTypeFromURL() {
	  const params = new URLSearchParams(window.location.search);
	  return params.get("type");
	}
	
function getInternalFromURL() {
	  const params = new URLSearchParams(window.location.search);
	  return params.get("internal");
	}
function getSupIdFromURL() {
	  const params = new URLSearchParams(window.location.search);
	  return params.get("supId");
	}


function initMap() {
	  const urlParams = new URLSearchParams(window.location.search);

	  // read params
	  const centerLat = parseFloat(urlParams.get('lat')) || 33.6;
	  const centerLng = parseFloat(urlParams.get('lng')) || -7.6;

	  // init map
	  map = new google.maps.Map(document.getElementById("map"), {
	    zoom: 10,
	    center: { lat: centerLat, lng: centerLng },
	  });

	  // show the passed marker immediately
	  new google.maps.Marker({
	    position: { lat: centerLat, lng: centerLng },
	    map: map,
	  });

	  // legend
	  initLegend();

	  // fetch drivers linked to this jobId
	  fetchDriversLocations();
	  setInterval(() => fetchDriversLocations(), 300000); // Refresh every 5 mins
	}

function initLegend() {
  const legend = document.getElementById('legend');
  const legendHeader = document.getElementById('legend-header');
  const legendClose = document.getElementById('legend-close');
  const legendToggle = document.getElementById('legend-toggle');
  const legendContent = document.getElementById('legend-content');

  // Make legend draggable
  legendHeader.addEventListener('mousedown', startDrag);
  document.addEventListener('mousemove', drag);
  document.addEventListener('mouseup', stopDrag);

  // Close/Open legend functionality
  legendClose.addEventListener('click', function() {
    legend.style.display = 'none';
    legendToggle.style.display = 'block';
  });

  legendToggle.addEventListener('click', function() {
    legend.style.display = 'block';
    legendToggle.style.display = 'none';
  });

  function startDrag(e) {
    isDragging = true;
    legend.classList.add('dragging');
    
    const rect = legend.getBoundingClientRect();
    dragOffset.x = e.clientX - rect.left;
    dragOffset.y = e.clientY - rect.top;
    
    e.preventDefault();
  }

  function drag(e) {
    if (!isDragging) return;
    
    const x = e.clientX - dragOffset.x;
    const y = e.clientY - dragOffset.y;
    
    // Keep legend within viewport bounds
    const maxX = window.innerWidth - legend.offsetWidth;
    const maxY = window.innerHeight - legend.offsetHeight;
    
    const constrainedX = Math.max(0, Math.min(x, maxX));
    const constrainedY = Math.max(0, Math.min(y, maxY));
    
    legend.style.left = constrainedX + 'px';
    legend.style.top = constrainedY + 'px';
    legend.style.bottom = 'auto';
  }

  function stopDrag() {
    if (isDragging) {
      isDragging = false;
      legend.classList.remove('dragging');
    }
  }

  // Prevent text selection while dragging
  legendHeader.addEventListener('selectstart', function(e) {
    e.preventDefault();
  });
}

function fetchDriversLocations() {
	const jobId = getJobIdFromURL();
	  if (!jobId) {
	    console.error("Aucun jobId trouvé dans l'URL.");
	    return;
	  }
	  const type = getTypeFromURL();
	  if (!type) {
	    console.error("Aucun type trouvé dans l'URL.");
	    return;
	  }
	  const internal = getInternalFromURL();
	  if (!internal) {
		    console.error("Aucun type trouvé dans l'URL.");
		    return;
		  }
	  const supId = getSupIdFromURL();

	  if (!supId) {
		    console.error("Aucun type trouvé dans l'URL.");
		    return;
		  }
	  
  fetch(`/api/driver-locations/drivers/${jobId}/${type}/${internal}/${supId}`)
    .then(response => {
      if (!response.ok) throw new Error("Erreur lors de la récupération des chauffeurs");
      return response.json();
    })
    .then(locations => {
      clearMarkers();
      locations.forEach(location => {
        if (location.latitude && location.longitude) {
          const position = { lat: location.latitude, lng: location.longitude };

          const borderColor = getBorderColor(location.date);
          
          // Default icon URL
          const defaultIconUrl = "https://cdn-icons-png.flaticon.com/512/149/149072.png";
          
          // Use user's imageUrl if available, otherwise use default
          const imageUrl = location.imageUrl && location.imageUrl.trim() !== "" 
            ? location.imageUrl 
            : defaultIconUrl;

          // Create PNG icon dynamically
          createPngIcon(imageUrl, borderColor, (iconUrl) => {
            const marker = new google.maps.Marker({
              position: position,
              map: map,
              icon: {
                url: iconUrl,
                scaledSize: new google.maps.Size(60, 60),
                anchor: new google.maps.Point(30, 30)
              },
              title: location.username || "Chauffeur inconnu"
            });

            const infoWindow = new google.maps.InfoWindow({
              content: `
                <div style="display:flex;align-items:center;">
                  <img src="${imageUrl}" style="width:50px;height:50px;border-radius:50%;margin-right:10px;" onerror="this.src='${defaultIconUrl}'" />
                  <div>
                    <strong>${location.username || 'Chauffeur inconnu'}</strong><br/>
                    <span>Latitude: ${location.latitude.toFixed(5)}</span><br/>
                    <span>Longitude: ${location.longitude.toFixed(5)}</span><br/>
                    <span>Date: ${new Date(location.date).toLocaleString()}</span>
                  </div>
                </div>
              `
            });

            marker.addListener("click", () => infoWindow.open(map, marker));
            markers.push(marker);
          });
        }
      });
    })
    .catch(err => {
      console.error("Erreur fetch des positions :", err);
    });
}

function getBorderColor(dateString) {
  const now = new Date();
  const lastDate = new Date(dateString);
  const diffHours = (now - lastDate) / (1000 * 60 * 60);

  if (diffHours < 24) return "green";
  if (diffHours < 48) return "blue";
  return "red";
}

// Generate PNG with border using Canvas
function createPngIcon(imageUrl, borderColor, callback) {
  const size = 60;
  const border = 5;
  const canvas = document.createElement("canvas");
  canvas.width = size;
  canvas.height = size;
  const ctx = canvas.getContext("2d");

  // Border circle
  ctx.beginPath();
  ctx.arc(size / 2, size / 2, size / 2 - 1, 0, 2 * Math.PI);
  ctx.fillStyle = borderColor;
  ctx.fill();

  const img = new Image();
  img.crossOrigin = "anonymous"; 
  img.onload = () => {
    ctx.save();
    ctx.beginPath();
    ctx.arc(size / 2, size / 2, size / 2 - border, 0, 2 * Math.PI);
    ctx.clip();
    ctx.drawImage(img, border, border, size - border * 2, size - border * 2);
    ctx.restore();

    callback(canvas.toDataURL("image/png"));
  };
  
  // Handle image load error - fallback to default icon
  img.onerror = () => {
    const defaultImg = new Image();
    defaultImg.crossOrigin = "anonymous";
    defaultImg.onload = () => {
      ctx.save();
      ctx.beginPath();
      ctx.arc(size / 2, size / 2, size / 2 - border, 0, 2 * Math.PI);
      ctx.clip();
      ctx.drawImage(defaultImg, border, border, size - border * 2, size - border * 2);
      ctx.restore();

      callback(canvas.toDataURL("image/png"));
    };
    defaultImg.src = "https://cdn-icons-png.flaticon.com/512/149/149072.png";
  };
  
  img.src = imageUrl;
}

function clearMarkers() {
  markers.forEach(marker => marker.setMap(null));
  markers = [];
}

window.initMap = initMap;
</script>

  <script
    async
    defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCyNTc451BOCfr7mSXaEKGtNBMFepsxT3I&callback=initMap">
  </script>
</body>
</html>