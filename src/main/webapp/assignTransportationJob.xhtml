<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<ui:composition xmlns="http://www.w3c.org/1999/xhtml"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:p="http://primefaces.org/ui"
	xmlns:c="http://java.sun.com/jsp/jstl/core"
	xmlns:fn="http://java.sun.com/jsp/jstl/functions"
	template="template/template.xhtml"
	xmlns:pe="http://primefaces.org/ui/extensions">
	<ui:define name="title">
		<h:outputText value="#{staticView.applicationName}" />
	</ui:define>
	<ui:define name="header">
		<ui:include src="template/header.xhtml" />
		<script
			src="https://maps.google.com/maps/api/js?key=AIzaSyCsA6hQ1C8D6IIeB_r2WDEEgPelvpUWIf8&amp;region=MA"
			type="text/javascript" />
	</ui:define>
	<ui:define name="sider">
		<ui:include src="template/sider.xhtml" />
	</ui:define>
	<ui:define name="navigator">
		<ul class="breadcrumb">
			<li><i class="ace-icon fa fa-home" /> <a href="#"> <h:outputText
						value="Main Menu" />
			</a></li>
			<li class="active"><h:outputText
					value="Assign Transportation Job" /></li>
		</ul>
	</ui:define>
	<ui:define name="body">
		<p:importEnum type="ma.azdad.model.TransportationJobAssignmentType"
			var="TransportationJobAssignmentType" allSuffix="ALL_ENUM_VALUES" />
		<h:form id="main_form">
			<div class="page-header hidden-xs">
				<h1>
					<h:outputText value="Assign" />
				</h1>
			</div>
			<div class="row">
				<div class="col-sm-12">
					<div class=" col-sm-offset-1 col-sm-4">
						<h:outputLink
							styleClass="btn btn-app btn-sm btn-inverse hover aa-tooltip"
							title="Return to Home " value="/index.xhtml">
							<i class="ace-icon fa fa-home bigger-230"></i>
							<h:outputText value="Home" />
						</h:outputLink>
						<h:outputLink
							styleClass="btn btn-app btn-sm btn-primary hover aa-tooltip"
							title="Reload page">
							<i class="ace-icon fa fa-refresh bigger-230"></i>
							<h:outputText value="Reload" />
						</h:outputLink>
						<h:outputLink styleClass="btn btn-app btn-sm hover aa-tooltip"
							title="Previous Page" value="javascript: window.history.go(-1)">
							<i class="ace-icon fa fa-undo bigger-230"></i>
							<h:outputText value="Back" />
						</h:outputLink>
						<p:commandLink title="Assign"
							styleClass="btn btn-app btn-sm btn-success hover aa-tooltip tooltip-success"
							action="#{transportationJobView.assign()}" update="messages">
							<i class="ace-icon fa fa-link bigger-230"></i>
							<h:outputText value="Assign" />
						</p:commandLink>
					</div>
				</div>
			</div>
			<div class="hr dotted" />
			<div class="row">
    <div class="col-sm-12">
        <div class="tabbable">
            <ul class="nav nav-tabs padding-16">
                <li class="active"><a data-toggle="tab" href="#tab1"> 
                    <i class="green fa fa-edit bigger-125"></i> 
                    <h:outputText value="Assign Transportation Job" />
                </a></li>
            </ul>
        </div>
        
        <div class="tab-content profile-edit-tab-content">
            <div class="tab-pane in active">
                
                
                <!-- Step Progress Indicator -->
                <div class="row">
                    <div class="col-sm-12">
                        <div class="step-progress">
                            <div class="step #{transportationJobView.currentStep >= 1 ? 'active' : ''} #{transportationJobView.currentStep > 1 ? 'completed' : ''}">
                                <span class="step-number">1</span>
                                <span class="step-title">Assignment Selection</span>
                            </div>
                            <div class="step #{transportationJobView.currentStep >= 2 ? 'active' : ''}">
                                <span class="step-number">2</span>
                                <span class="step-title">Schedule And Location</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="space-16"></div>
				<p:messages id="messages" closable="true" />
                <!-- STEP 1: Assignment Selection (Assignment Type, Drivers/Transporters, Vehicle, Map) -->
                <h:panelGroup id="main_pan" rendered="#{transportationJobView.currentStep == 1}">
                    <h4 class="header blue bolder smaller">
                        <i class="fa fa-user"></i>
                        <h:outputText value="Step 1: Assignment Selection" />
                    </h4>
                    
                    <!-- Assignment Type Selection -->
                    <div class="row">
                        <div class="col-xs-12 col-sm-6">
                            <div class="form-group">
                                <label class="col-xs-3 col-sm-3 control-label no-padding-right">
                                    <h:outputText value="Assignment Type" />
                                </label>
                                <div class="col-xs-9 col-sm-9">
                                    <h:selectOneMenu value="#{transportationJobView.transportationJob.assignmentType}"
                                                   required="true" requiredMessage="Type should not be null">
                                        <f:selectItem itemLabel="---" noSelectionOption="true" />
                                        <f:selectItem itemLabel="#{TransportationJobAssignmentType.TRANSPORTER.value}"
                                                    itemValue="#{TransportationJobAssignmentType.TRANSPORTER}" />
                                        <f:selectItem itemLabel="#{TransportationJobAssignmentType.INTERNAL_DRIVER.value}"
                                                    itemValue="#{TransportationJobAssignmentType.INTERNAL_DRIVER}" />
                                        <f:selectItem itemLabel="#{TransportationJobAssignmentType.EXTERNAL_DRIVER.value}"
                                                    itemValue="#{TransportationJobAssignmentType.EXTERNAL_DRIVER}" />
                                        <p:ajax listener="#{transportationJobView.changeTransportationJobAssignmentTypeListener()}"
                                              update="assignmentSelectionPanel,mapPanel,main_pan" />
                                    </h:selectOneMenu>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="space-16"></div>

                    <!-- Assignment Selection Panel -->
                    <h:panelGroup id="assignmentSelectionPanel">
                        <!-- Transporter Selection -->
                        <f:subview rendered="#{TransportationJobAssignmentType.TRANSPORTER==transportationJobView.transportationJob.assignmentType}">
                            <div class="row">
                                <div class="col-sm-12">
                                    <div class="table-header col-sm-12 col-xs-12">
                                        <div class="col-sm-10 hidden-xs">
                                            <i class="fa fa-list" />
                                            <h:outputText value=" Select Transporter" />
                                        </div>
                                        <div class="col-sm-2 col-xs-4">
                                            <div class="nav-search minimized">
                                                <span class="input-icon">
                                                    <p:inputText value="#{transporterView.searchBean}"
                                                               placeholder="Search..."
                                                               styleClass="input-small nav-search-input"
                                                               autocomplete="off">
                                                        <p:ajax event="keyup" update="transporterList" />
                                                    </p:inputText>
                                                    <i class="ace-icon fa fa-search nav-search-icon" />
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-sm-12 col-xs-12 aa-datatable-container">
                                        <p:dataTable id="transporterList" widgetVar="transporterList"
                                                   value="#{transporterView.list2}" filteredValue="#{transporterView.list3}"
                                                   rowKey="#{item.id}"
                                                   selection="#{transportationJobView.transportationJob.transporter}"
                                                   var="item" rows="5"
                                                   styleClass="table table-striped table-hover center"
                                                   paginatorAlwaysVisible="false" paginator="true"
                                                   paginatorPosition="bottom"
                                                   rowSelectMode="checkbox">
                                            <p:ajax event="rowSelectRadio" update="@(.map-container)" />
                                            <p:column selectionMode="single" styleClass="ace aa-checkbox-column" />
                                            <p:column headerText="Name">
                                                <h:outputText value="#{item.name}" styleClass="bolder orange" />
                                            </p:column>
                                            <p:column headerText="Type">
                                                <h:outputText value="#{item.type.value}" styleClass="#{item.type.color}" />
                                            </p:column>
                                            <p:column headerText="Email">
                                                <h:outputText value="#{item.email}" styleClass="bolder light-blue" />
                                            </p:column>
                                            <p:column headerText="Phone">
                                                <h:outputText value="#{item.phone}" styleClass="bolder light-green" />
                                            </p:column>
                                        </p:dataTable>
                                    </div>
                                </div>
                            </div>
                        </f:subview>

                        <!-- Driver Selection -->
                        <!-- Driver Selection -->
<f:subview rendered="#{TransportationJobAssignmentType.INTERNAL_DRIVER==transportationJobView.transportationJob.assignmentType or TransportationJobAssignmentType.EXTERNAL_DRIVER==transportationJobView.transportationJob.assignmentType}">
    <div class="row">
        <div class="col-sm-12">
            <div class="table-header col-sm-12 col-xs-12">
                <div class="col-sm-6 hidden-xs">
                    <i class="fa fa-truck" />
                    <h:outputText value=" Select Driver" />
                </div>
                <div class="col-sm-4 hidden-xs">
                    <i class="fa fa-list" />
                    <h:outputText value=" Sort By " style="margin-right:20px" />
                    <h:selectOneMenu value="#{userView.sortBy}">
                        <f:selectItem itemLabel="Pending TR" itemValue="Pending TR" />
                        <f:selectItem itemLabel="Reactivity" itemValue="Reactivity" />
                        <f:selectItem itemLabel="Distance to site" itemValue="Distance to site" />
                        <p:ajax listener="#{userView.sort()}" update="driverList" />
                    </h:selectOneMenu>
                </div>
                <div class="col-sm-2 col-xs-4">
                    <div class="nav-search minimized">
                        <span class="input-icon">
                            <p:inputText value="#{userView.searchBean}" placeholder="Search..."
                                       styleClass="input-small nav-search-input" autocomplete="off">
                                <p:ajax event="keyup" update="driverList" />
                            </p:inputText>
                            <i class="ace-icon fa fa-search nav-search-icon" />
                        </span>
                    </div>
                </div>
            </div>
            <div class="col-sm-12 col-xs-12 aa-datatable-container">
                <p:dataTable id="driverList" widgetVar="driverList"
                           value="#{userView.list2}" filteredValue="#{userView.list3}"
                           rowKey="#{item.username}"
                           selection="#{transportationJobView.transportationJob.driver}"
                           var="item" rows="5"
                           styleClass="table table-striped table-hover center"
                           paginatorAlwaysVisible="false" paginator="true"
                           paginatorPosition="bottom" rowSelectMode="checkbox">
                    <!-- Change this line to use relative update -->
                    <p:ajax event="rowSelectRadio" update=":main_form:main_pan" />
                    <p:column selectionMode="single" styleClass="ace aa-checkbox-column" />
                    <p:column headerText="Photo" width="80" exportable="false" styleClass="hidden-xs">
                        <p:graphicImage value="#{fileUploadView.stream}" styleClass="img-circle aa-datatable-photo">
                            <f:param name="fileName" value="#{item.photo}" />
                        </p:graphicImage>
                    </p:column>
                    <p:column headerText="Full Name">
                        <h:outputText value="#{item.fullName}" styleClass="bolder green" />
                    </p:column>
                    <p:column headerText="Transporter">
                        <h:outputText value="#{item.transporterName}" styleClass="bolder pink" />
                    </p:column>
                    <p:column headerText="Email">
                        <h:outputText value="#{item.email}" styleClass="blue" />
                    </p:column>
                    <p:column headerText="Phone">
                        <h:outputText value="#{item.phone}" styleClass="orange" />
                    </p:column>
                    <p:column headerText="CIN">
                        <h:outputText value="#{item.cin}" styleClass="bolder purple" />
                    </p:column>
                    <p:column headerText="Pending TR" styleClass="#{userView.sortBy=='Pending TR'?'aa-background-blue':''}">
                        <h:outputText value="#{item.countPendingTr}" styleClass="bolder" />
                    </p:column>
                    <p:column headerText="Reactivity" styleClass="#{userView.sortBy=='Reactivity'?'aa-background-blue':''}">
                        <h:outputText value="#{item.reactivity}">
                            <f:convertNumber type="number" maxFractionDigits="0" />
                        </h:outputText>
                        <h:outputText value=" %" />
                    </p:column>
                    <p:column headerText="Distance To Site" styleClass="#{userView.sortBy=='Distance to site'?'aa-background-blue':''}">
                        <h:outputText value="#{item.distance}">
                            <f:convertNumber type="number" maxFractionDigits="0" />
                        </h:outputText>
                        <h:outputText value=" Km" rendered="#{item.distance!=null}" />
                    </p:column>
                </p:dataTable>
            </div>
        </div>
    </div>
</f:subview>

						<!-- Move Vehicle Selection Panel Outside of Subview -->
						<h:panelGroup id="vehicleListPanel">
									<f:subview
										rendered="#{transportationJobView.transportationJob.driver!=null}">
										<div class="space-8" />
										<div class="row">
											<div class="col-sm-offset-1 col-sm-10">
												<div class="table-header col-sm-12 col-xs-12">
													<i class="fa fa-list" />
													<h:outputText value=" Vehicle List" />
												</div>
												<div class="col-sm-12 col-xs-12 aa-datatable-container">
													<p:dataTable id="vehicleList" widgetVar="vehicleList"
														value="#{transportationJobView.vehicleSelectionList}"
														rowKey="#{item.id}"
													
														selection="#{transportationJobView.transportationJob.vehicle}"
														var="item" rows="5"
														styleClass="table table-striped table-hover center"
														paginatorAlwaysVisible="false" paginator="true"
														paginatorPosition="bottom"
														paginatorTemplate="{JumpToPageDropdown} {LastPageLink} {FirstPageLink}  {PageLinks}"
														rowSelectMode="checkbox">
														 <p:ajax event="rowSelectRadio" update=":main_form:main_pan" />
														<p:column selectionMode="single"
															styleClass="ace aa-checkbox-column" />
														<p:column headerText="Matricule">
															<h:outputText value="#{item.correctMatricule}"
																styleClass="purple bolder" />
														</p:column>
														<p:column headerText="Vehicle Type">
															<h:outputText value="#{item.vehicleType.name}"
																styleClass="bolder green" />
														</p:column>
														<p:column headerText="Max Weight">
															<h:outputText value="#{item.maxWeight}">
																<f:convertNumber type="number" maxFractionDigits="2" />
															</h:outputText>
															<h:outputText value=" Kg" />
														</p:column>
														<p:column headerText="Max Volume">
															<h:outputText value="#{item.maxVolume}">
																<f:convertNumber type="number" maxFractionDigits="2" />
															</h:outputText>
															<h:outputText value=" m3" />
														</p:column>
													</p:dataTable>
												</div>
											</div>
										</div>
									</f:subview>
								</h:panelGroup>
                    </h:panelGroup>

                    <!-- Map for Step 1 -->
                    <div class="space-16"></div>
                    <div class="map-container">
                        <h:panelGroup id="mapPanel">
                            <h5 class="header smaller blue">
                                <i class="fa fa-map-marker"></i>
                                <h:outputText value=" Current Selection Overview" />
                            </h5>
                            <iframe src="#{request.contextPath}/transportationJobAssignMap.html?jobId=#{transportationJobView.transportationJob.id}&amp;type=#{transportationJobView.transportationJob.assignmentType.value}&amp;step=1"
                                    style="width: 100%; height: 400px; border: none;">
                            </iframe>
                        </h:panelGroup>
                    </div>

                    <!-- Step 1 Navigation -->
                    <div class="space-16"></div>
                    <div class="row">
                        <div class="col-sm-12 text-right">
                            <p:commandButton value="Next: Schedule And Location" 
                                           action="#{transportationJobView.goToStep2()}"
                                           update=":main_form"
                                           styleClass="btn btn-primary"
                                           disabled="#{transportationJobView.isStep1Incomplete()}" />
                        </div>
                    </div>
                </h:panelGroup>

                <!-- STEP 2: Schedule & Location (Lead Times, Position, Map) -->
                <h:panelGroup rendered="#{transportationJobView.currentStep == 2}">
                    <h4 class="header blue bolder smaller">
                        <i class="fa fa-clock-o"></i>
                        <h:outputText value="Step 2: Schedule And Location Details" />
                    </h4>

                    <!-- Lead Times -->
                    <div class="row">
                        <div class="col-xs-12 col-sm-6">
                            <div class="form-group">
                                <label class="col-xs-4 col-sm-4 control-label no-padding-right">
                                    <h:outputText value="Accept Lead Time" />
                                </label>
                                <div class="col-xs-8 col-sm-8">
                                    <p:inputNumber value="#{transportationJobView.transportationJob.acceptLeadTime}"
                                                 thousandSeparator="" decimalSeparator="." minValue="0"
                                                 required="true" requiredMessage="Accept Lead Time should not be null"
                                                 placeholder="(in hours)" />
                                </div>
                            </div>
                        </div>
                        <div class="col-xs-12 col-sm-6">
                            <div class="form-group">
                                <label class="col-xs-4 col-sm-4 control-label no-padding-right">
                                    <h:outputText value="Start Lead Time" />
                                </label>
                                <div class="col-xs-8 col-sm-8">
                                    <p:inputNumber value="#{transportationJobView.transportationJob.startLeadTime}"
                                                 thousandSeparator="" decimalSeparator="." minValue="0"
                                                 required="true" requiredMessage="Start Lead Time should not be null"
                                                 placeholder="(in hours)" />
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="space-16"></div>

                    <!-- Position Selection -->
                    <h5 class="header smaller blue">
                        <i class="fa fa-map-marker"></i>
                        <h:outputText value=" Planned Start Location" />
                    </h5>
                    <div class="row">
                        <div class="col-xs-12 col-sm-6">
                            <div class="form-group">
                                <label class="col-xs-4 col-sm-4 control-label no-padding-right">
                                    <h:outputText value="Latitude" />
                                </label>
                                <div class="col-xs-8 col-sm-8">
                                    <p:inputText id="lat" value="#{transportationJobView.transportationJob.plannedStartLatitude}"
                                               required="true" readonly="true"
                                               requiredMessage="Latitude should not be null. Please select by clicking on the map!"
                                               placeholder="Click on map to set latitude" />
                                </div>
                            </div>
                        </div>
                        <div class="col-xs-12 col-sm-6">
                            <div class="form-group">
                                <label class="col-xs-4 col-sm-4 control-label no-padding-right">
                                    <h:outputText value="Longitude" />
                                </label>
                                <div class="col-xs-8 col-sm-8">
                                    <p:inputText id="lng" value="#{transportationJobView.transportationJob.plannedStartLongitude}"
                                               required="true" readonly="true"
                                               requiredMessage="Longitude should not be null. Please select by clicking on the map!"
                                               placeholder="Click on map to set longitude" />
                                </div>
                            </div>
                        </div>
                    </div>
                    <p:commandButton id="updateCoordsBtn" 
												action="#{transportationJobView.updateCoordinates()}"
												
												style="display:none;" />
								
								<!-- Hidden inputs to capture map coordinates -->
								<p:inputText id="hiddenLat" value="#{transportationJobView.mapLatitude}" style="display:none;" />
								<p:inputText id="hiddenLng" value="#{transportationJobView.mapLongitude}" style="display:none;" />

                    <!-- Interactive Map for Step 2 -->
                    <div class="space-16"></div>
                    <div class="alert alert-info">
                        <i class="fa fa-info-circle"></i>
                        <strong>Instructions:</strong> Click on the map below to set the planned start location for this transportation job.
                    </div>
                    <iframe src="#{request.contextPath}/transportationJobAssignMap.html?jobId=#{transportationJobView.transportationJob.id}&amp;type=#{transportationJobView.transportationJob.assignmentType.value}&amp;step=2"
                            style="width: 100%; height: 500px; border: none;">
                    </iframe>

                    <!-- Step 2 Navigation -->
                    <div class="space-16"></div>
                    <div class="row">
                        <div class="col-sm-6">
                            <p:commandButton value="← Back to Selection" 
                                           action="#{transportationJobView.goToStep1()}"
                                           update=":main_form"
                                           styleClass="btn btn-default" />
                        </div>
                        <div class="col-sm-6 text-right">
                            <p:commandLink  value="Complete Assignment" 
                                           action="#{transportationJobView.assign()}"
                                           	update="messages"
                                           styleClass="btn btn-success"
                                            ></p:commandLink>
                        </div>
                    </div>
                </h:panelGroup>

            </div>
        </div>
    </div>
</div>

<style>
.step-progress {
    display: flex;
    justify-content: center;
    align-items: center;
    margin: 20px 0;
}

.step {
    display: flex;
    flex-direction: column;
    align-items: center;
    margin: 0 30px;
    position: relative;
}

.step:not(:last-child)::after {
    content: '';
    position: absolute;
    top: 20px;
    right: -30px;
    width: 60px;
    height: 2px;
    background-color: #ddd;
    z-index: -1;
}

.step.completed:not(:last-child)::after {
    background-color: #5cb85c;
}

.step-number {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background-color: #ddd;
    color: #666;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    margin-bottom: 8px;
}

.step.active .step-number {
    background-color: #337ab7;
    color: white;
}

.step.completed .step-number {
    background-color: #5cb85c;
    color: white;
}

.step-title {
    font-size: 12px;
    color: #666;
    text-align: center;
}

.step.active .step-title {
    color: #337ab7;
    font-weight: bold;
}

.step.completed .step-title {
    color: #5cb85c;
    font-weight: bold;
}
</style>
		</h:form>
		<script>
  window.addEventListener("message", function (event) {
	  if (event.data &amp;&amp; event.data.lat &amp;&amp; event.data.lng) {
      // Update the inputs inside main_form
      document.getElementById("main_form:lat").value = event.data.lat;
      document.getElementById("main_form:lng").value = event.data.lng;

   // Update the hidden inputs that will be submitted to the server
		document.getElementById("main_form:hiddenLat").value = event.data.lat;
		document.getElementById("main_form:hiddenLng").value = event.data.lng;

		// Trigger the hidden button to update coordinates in the bean
		document.getElementById("main_form:updateCoordsBtn").click();
    }
  });
</script>

	</ui:define>
</ui:composition>
